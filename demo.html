<!DOCTYPE html>
<html lang="en">

  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <title>Audio Warpin' Web Widgets</title>
    
    <script src="awww.js"></script>
    
    <style>

    a-knob {
        width: 74px;
        height: 74px;
    }

    a-resize {
        --graphic: dots;
    }

    a-resize path {
        fill: #000;
    }

    </style>

  </head>

  <body>

    <h2><a href="https://github.com/lucianoiam/awww" target="_blank">Awww</a></h2>
    <span id="watermark">ALPHA</span>
    <hr>

    <div id="widgets">

        <h4>Knob</h4>

        <a-knob
            min="0"
            max="2.0"
            value="0.5"
            oninput="toast(this.value.toFixed(2))">
        </a-knob>

        <hr>
        <h4>Resize Handle</h4>

        <div id="resize-container">

            <a-resize
                minwidth="200"
                minheight="100"
                maxscale="2"
                keepaspectratio="true"
                oninput="aResizeListener.call(this)">
            </a-resize>
        
        </div>

    </div>

    <pre id="log"></pre>


    <!-- Event listeners -->

    <script>

    function aResizeListener() {
        const style = this.parentNode.style;
        style.width = this.value.width + 'px';
        style.height = this.value.height + 'px';
        toast(Math.round(this.value.width) + 'x' + Math.round(this.value.height));
    }

    </script>


    <!-- END OF RELEVANT DEMO SOURCE -->

    <!--
      Placing a stylesheet here is non-standard but works on most browsers.
      It is done this way purely for keeping the interesting demo parts on top.
     -->

    <style>

    body {
        background: #000;
        color: #fff;
        font-family: sans-serif;
        margin: 0 20px;
        user-select: none;
        -webkit-user-select: none;
    }

    a {
        color: #fff;
    }

    pre {
        white-space: pre-wrap;
    }

    hr {
        opacity: 0.25;
    }

    a-resize line {
        stroke: #000; /* lines version */
    }

    #watermark {
        position: fixed;
        top: 25px;
        right: 25px;
        opacity: 0.5;
    }

    #log {
        background-color: rgba(0, 0, 0, 0.75);
        position: fixed;
        top: 0;
        left: 50%;
        transform: translate(-50%, 0);
        height: 3rem;
        font-size: 3rem;
        padding: 10px;
        margin: 0;
        border-radius: 5px;
        visibility: hidden;
    }

    #resize-container {
        box-sizing: border-box; /* make <a-resize> behave in a predictable way */
        position: relative;     /* support <a-resize> position:absolute */; 
        border-radius: 5px;
        background: #555;
        width: 300px;
        height: 150px;
    }

    </style>

    <script>

    let toastTimeout = null;

    const cssRuleList = document.styleSheets[0].cssRules;

    const widgets = [...document.getElementById('widgets').querySelectorAll('*')]
                        .filter(el => el.nodeName.startsWith('A-'));

    for (const widget of widgets) {

        const isDirectChild = widget.parentNode.id == 'widgets';
        const container = isDirectChild ? widget.parentNode : widget.parentNode.parentNode;
        const insertPointElem = isDirectChild ? widget : widget.parentNode;

        // Insert widget HTML before each widget

        const widgetClone = widget.cloneNode();
        widgetClone.removeAttribute('style');
        const preWithHtml = document.createElement('pre');
        preWithHtml.innerText = widgetClone.outerHTML;
        container.insertBefore(preWithHtml, insertPointElem);

        // Insert widget CSS after each widget

        for (const cssRule of cssRuleList) {
            if (cssRule.selectorText.startsWith(widget.nodeName.toLowerCase())) {
                const preWithCss = document.createElement('pre');
                const rule = cssRule.cssText.replaceAll('{', '{\n').replaceAll(';', ';\n')
                                .replace(/ +/g,' ');
                preWithCss.innerText = formatBlock(rule);
                container.insertBefore(preWithCss, insertPointElem.nextSibling);
            }
        }

        // Insert widget callback code after each widget

        const listener = widget.nodeName.split('-').map((s, i) => {
            return i > 0 ? s[0] + s.slice(1).toLowerCase() : s[0].toLowerCase();
        }).join('') + 'Listener'; // <a-knob> -> aKnobListener

        if (listener in window) {
            const preWithJs = document.createElement('pre');
            preWithJs.innerText = formatBlock(window[listener].toString())
            container.insertBefore(preWithJs, insertPointElem.nextSibling);
        }

    }

    function formatBlock(block) {
        const lines = block.split('\n');
        if (lines.length < 2) {
            return lines;
        } 
        return lines[0] + '\n'
                + lines.slice(1, lines.length - 1).map(l => '   ' + l.trim()).join('\n') + '\n'
                + lines.slice(-1)[0].trim();
    }

    function toast(text) {
        if (toastTimeout) {
            clearTimeout(toastTimeout);
        }

        const log = document.getElementById('log');

        log.innerText = text;
        log.style.visibility = 'visible';
        
        toastTimeout = setTimeout(() => log.style.visibility = 'hidden', 1000);
    }

    </script>

  </body>

</html>
